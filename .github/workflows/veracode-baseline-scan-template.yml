name: "Reusable Veracode Baseline Scan"

on:
  workflow_call:
    inputs:
      run-veracode-gate-check:
        description: "Run Veracode alert check? (yes/no)"
        type: string
        required: false
        default: "yes"

permissions:
  security-events: write
  packages: read
  actions: read
  contents: read

jobs:
  baseline:
    name: Baseline Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # - name: Download build artifacts
      #   uses: actions/download-artifact@v4
      #   with:
      #       name: dotnet-sourcecode
      #       path: ./source
      
      - name: Check Veracode Alerts
        run: |
          echo "🔎 Checking Veracode alerts for branch ${GITHUB_REF}..."

          CRITICAL=4
          HIGH=4
          MEDIUM=10
          LOW=20
          INFORMATIONAL=40

          echo "🔎 Veracode Severity Findings Summary:"
          echo "  Critical: $CRITICAL"
          echo "  High:     $HIGH"
          echo "  Medium:   $MEDIUM"
          echo "  Low:      $LOW"
          echo "  Informational:    $INFORMATIONAL"

          {
            echo "## 🔎 Veracode Severity Findings Summary"
            echo "- Critical: **$CRITICAL**"
            echo "- High: **$HIGH**"
            echo "- Medium: $MEDIUM"
            echo "- Low: $LOW"
            echo "- Informational: $INFORMATIONAL"
          } >> $GITHUB_STEP_SUMMARY

          
          INPUT_RUN_ALERT_CHECK=${{ inputs.run-veracode-gate-check }}
            if [[ "$INPUT_RUN_ALERT_CHECK" == "yes" ]] && { [[ "$CRITICAL" -gt 0 ]] || [[ "$HIGH" -gt 0 ]]; }; then
                echo "❌ Pipeline failed due to critical/high findings."
                exit 1
            elif [[ "$INPUT_RUN_ALERT_CHECK" == "no" ]]; then
                echo "⚠️ Gate check bypassed as per configuration (run-veracode-gate-check=no)." >> $GITHUB_STEP_SUMMARY
            else
                echo "✅ No critical/high findings. Continuing pipeline." >> $GITHUB_STEP_SUMMARY
            fi


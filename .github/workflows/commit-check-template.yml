name: "Commit Message Jira Check (Reusable)"

on:
  workflow_call:
    inputs:
      base_branch:
        description: "Base branch for comparison"
        required: true
        type: string
      jira_prefix:
        description: "Jira project key prefix (e.g., SCRUM, PROJ)"
        required: false
        type: string
        default: "[A-Z]+"

jobs:
  commit-lint:
    runs-on: ubuntu-latest
    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Validate commit messages for Jira keys
      - name: Validate commit messages for Jira keys
        if: ${{ github.event_name == 'pull_request' || github.event_name == 'push' }}
        run: |
          echo "üîç Checking commits against Jira ticket pattern..."
          
          # Determine commit range
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            range="${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }}"
          else
            range="${{ github.sha }}~1..${{ github.sha }}"
          fi

          commits=$(git log $range --pretty=format:"%s")
          missing=0

          echo "$commits" | while IFS= read -r msg; do
            if ! echo "$msg" | grep -iqE "(${GITHUB_INPUT_JIRA_PREFIX}-[0-9]+)"; then
              echo "‚ùå Commit missing Jira key: $msg"
              missing=1
            fi
          done

          if [ "$missing" -eq 1 ]; then
            echo "‚ùå One or more commits do not include a Jira ticket. Please fix commit messages."
            exit 1
          fi

      # 3Ô∏è‚É£ Check PR title for Jira key (only for PRs)
      - name: Check PR title for Jira key
        if: ${{ github.event_name == 'pull_request' }}
        run: |
          echo "üîç Checking PR title for Jira key..."
          pr_title="${{ github.event.pull_request.title }}"
          echo "PR title = $pr_title"
          if ! echo "$pr_title" | grep -iqE "(${GITHUB_INPUT_JIRA_PREFIX}-[0-9]+)"; then
            echo "‚ùå PR title missing Jira key: $pr_title"
            exit 1
          fi
          echo "‚úÖ PR title contains Jira key: $pr_title"

      # 4Ô∏è‚É£ Success
      - name: Success
        run: echo "‚úÖ All commits and PR title include Jira ticket!"
